import { FunctionComponent, createElement, useEffect, useRef } from 'react'

import { useOvermind } from '../../overmind'
import { isValidJson } from '../../overmind/utils'
import { colors } from '../../theme'
import * as styles from './styles'

const ActionPayload: FunctionComponent = () => {
  const { state, actions, reaction } = useOvermind()
  const input = useRef(null)

  useEffect(() => {
    reaction(
      () => state.currentApp.selectedActionQuery,
      () => setTimeout(() => input.current && input.current.focus())
    )
  }, [])

  const payload = state.currentApp.actionQueryPayload

  return (
    <div className={styles.wrapper}>
      <input
        ref={input}
        style={{
          borderColor:
            !payload || isValidJson(payload) ? 'transparent' : colors.red,
        }}
        disabled={
          !state.currentApp.selectedActionQuery || state.isExecutingAction
        }
        placeholder={
          state.currentApp.selectedActionQuery
            ? 'Add some JSON payload...'
            : null
        }
        onKeyDown={(event) => {
          if (event.keyCode === 13) {
            actions.executeAction()
          }
        }}
        className={styles.input}
        value={payload}
        onChange={(event) =>
          actions.setActionQueryPayload(event.currentTarget.value)
        }
      />
    </div>
  )
}

export default ActionPayload
