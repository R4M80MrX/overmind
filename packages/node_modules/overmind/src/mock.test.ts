import { IAction, IOnInitialize, createOvermindMock } from './'

describe('Mock', () => {
  test('should run action tests', () => {
    type State = {
      foo: string
    }
    const state: State = {
      foo: 'bar',
    }
    const test: Action = ({ state, effects }) => {
      state.foo = effects.effect('bar2')
    }
    const actions = { test }
    const effect = (arg: string) => arg
    const effects = { effect }
    const config = {
      state,
      actions,
      effects,
    }

    type Config = typeof config

    interface Action<Input = void> extends IAction<Config, Input> {}

    const overmind = createOvermindMock(config, {
      effect(arg) {
        return arg + '!!!'
      },
    })

    overmind.actions.test()

    expect(overmind.mutations).toEqual([
      {
        method: 'set',
        path: 'foo',
        args: ['bar2!!!'],
        hasChangedValue: true,
        revert: overmind.mutations[0].revert,
      },
    ])
  })
  test('should test onInitialize explicitly', () => {
    type State = {
      foo: string
    }
    const state: State = {
      foo: 'bar',
    }
    const onInitialize: OnInitialize = ({ state }) => {
      state.foo += '!'
    }

    const config = {
      onInitialize,
      state,
    }

    type Config = typeof config

    interface OnInitialize extends IOnInitialize<Config> {}

    const overmind = createOvermindMock(config, {
      effect() {
        return 'bar3'
      },
    })

    overmind.onInitialize()

    expect(overmind.mutations).toEqual([
      {
        method: 'set',
        path: 'foo',
        args: ['bar!'],
        hasChangedValue: true,
        revert: overmind.mutations[0].revert,
      },
    ])
  })
})
